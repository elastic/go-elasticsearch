name: Bump Go Version

on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  bump-go-version:
    name: Bump Go Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.0

      - name: Fetch ephemeral GitHub token
        id: fetch-token
        uses: elastic/ci-gh-actions/fetch-github-token@8a7604dfdd4e7fe21f969bfe9ff96e17635ea577 # v1.0.0
        with:
          vault-instance: "ci-prod"

      - name: Determine Go versions
        id: go-versions
        shell: bash
        run: |
          set -euo pipefail

          latest_two=$(curl -s https://go.dev/dl/?mode=json | jq -r '
            reduce (
              .[] |
              select(.stable == true) |
              .version |
              sub("^go";"") |
              split(".") |
              .[0:2] |
              join(".")
            ) as $v
            ([]; if index($v) then . else . + [$v] end)
            | .[0:2]
            | @tsv
          ')

          latest1=$(echo "$latest_two" | awk '{print $1}')
          latest2=$(echo "$latest_two" | awk '{print $2}')

          mapfile -t go_mod_files < <(find . -name go.mod -print | grep -v '^./_examples/' | grep -v '^./_benchmarks/')

          needs_update=false
          updates=()
          updated_files=()

          for mod_file in "${go_mod_files[@]}"; do
            current_go=$(awk '/^go / {print $2}' "$mod_file")

            if [[ "$current_go" == "$latest1" || "$current_go" == "$latest2" ]]; then
              continue
            fi

            sed -i -e "s/^go .*/go ${latest2}/" "$mod_file"
            if grep -q '^toolchain ' "$mod_file"; then
              sed -i -e "s/^toolchain .*/toolchain go${latest2}.0/" "$mod_file"
            fi

            updates+=("${mod_file#./}: ${current_go} -> ${latest2}")
            updated_files+=("${mod_file#./}")
            needs_update=true
          done

          if [[ "$needs_update" == "false" ]]; then
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "needs_update=true" >> "$GITHUB_OUTPUT"
          echo "latest1=$latest1" >> "$GITHUB_OUTPUT"
          echo "latest2=$latest2" >> "$GITHUB_OUTPUT"
          echo "target=$latest2" >> "$GITHUB_OUTPUT"

          {
            echo "updated_modules<<'EOF'"
            for entry in "${updates[@]}"; do
              echo "$entry"
            done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "updated_files<<'EOF'"
            for entry in "${updated_files[@]}"; do
              echo "$entry"
            done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Set up Go
        if: steps.go-versions.outputs.needs_update == 'true'
        uses: actions/setup-go@v2.1.3
        with:
          go-version: ${{ steps.go-versions.outputs.target }}

      - name: Update go.mod and tidy
        if: steps.go-versions.outputs.needs_update == 'true'
        shell: bash
        run: |
          set -euo pipefail

          while IFS= read -r mod_file; do
            [[ -z "$mod_file" ]] && continue
            mod_dir=$(dirname "$mod_file")
            if [[ -f "${mod_dir}/go.sum" ]]; then
              (cd "$mod_dir" && go mod tidy)
            fi
          done <<'EOF'
          ${{ steps.go-versions.outputs.updated_files }}
          EOF

      - name: Create PR
        if: steps.go-versions.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          token: ${{ steps.fetch-token.outputs.token }}
          commit-message: "feat!: bump go version to ${{ steps.go-versions.outputs.target }}"
          committer: "Elastic Machine <elasticmachine@users.noreply.github.com>"
          author: "Elastic Machine <elasticmachine@users.noreply.github.com>"
          branch: "go-version-bump-${{ steps.go-versions.outputs.target }}"
          delete-branch: true
          base: main
          title: "feat!: bump go version to ${{ steps.go-versions.outputs.target }}"
          body: |
            Bumps Go version to ${{ steps.go-versions.outputs.target }}.

            Updated go.mod files:
            ${{ steps.go-versions.outputs.updated_modules }}

